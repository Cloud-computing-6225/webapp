name: Build and Deploy Custom Image

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository to get the webapp and packer folders
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Build the application artifact (zip)
      - name: Build Application Artifact
        run: |
          zip -r app.zip . -x ".git/*" -x ".github/*"  # Creates the artifact
        env:
          NODE_ENV: production

      # Step 3: Upload the artifact to GitHub Actions
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: app.zip  # This artifact will be passed to the Packer build
          path: app.zip

  packer_build:
    needs: build
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout Code to get the webapp and packer folders
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Download the built application artifact
      - name: Download Application Artifact
        uses: actions/download-artifact@v3
        with:
          name: app.zip

      # Step 3: Move the artifact to the packer folder
      - name: Move Artifact to Packer Folder
        run: |
          mv app.zip ./webapp/packer/  # Move the zipped artifact to the correct folder

      # Step 4: Set up Packer
      - name: Set up Packer
        uses: hashicorp/setup-packer@main
        id: setup
        with:
         version: 1.11.2

      # Step 5: Run Packer to build the custom image
      - name: Run Packer
        working-directory: ./webapp/packer  # Ensure we are in the correct directory where the Packer files are
        run: |
          packer init aws.pkr.hcl  # Initialize Packer with the configuration
          packer build -var "aws_access_key=${{ secrets.ACCESS_KEY }}" \
                       -var "aws_secret_access_key=${{ secrets.SECRET_ACCESS_KEY }}" \
                       aws.pkr.hcl
